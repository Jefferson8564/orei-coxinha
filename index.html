<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üõµ Entregador ‚Äî O Rei da Coxinha</title>
<link rel="icon" href="icone.png">
<link rel="apple-touch-icon" href="icone.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a0a0f">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Rei Entregas">
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800;900&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f; --surface: #12121a; --surface2: #1a1a26;
  --border: rgba(255,255,255,0.07); --primary: #f5a623;
  --primary-glow: rgba(245,166,35,0.3); --green: #00e87a;
  --blue: #3d9cff; --red: #ff4757;
  --text: #f0f0f8; --text-dim: rgba(240,240,248,0.5);
  --text-muted: rgba(240,240,248,0.28);
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { width:100%; height:100%; overflow:hidden; background:var(--bg); color:var(--text); font-family:'DM Sans',sans-serif; }
#map { position:fixed; inset:0; z-index:1; }

/* LOADING */
#loadingScreen { position:fixed; inset:0; z-index:9999; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; }
.load-logo { font-size:56px; animation:logoPulse 1.4s ease-in-out infinite; filter:drop-shadow(0 0 24px var(--primary-glow)); }
@keyframes logoPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.1);}}
.load-title { font-family:'Syne',sans-serif; font-size:22px; font-weight:900; }
.load-sub { font-size:13px; color:var(--text-muted); }
.load-bar-wrap { width:160px; height:3px; background:rgba(255,255,255,0.08); border-radius:10px; overflow:hidden; }
.load-bar { height:100%; width:0%; background:linear-gradient(90deg,var(--primary),#ff8c00); border-radius:10px; animation:loadBar 1.8s ease forwards; }
@keyframes loadBar{to{width:100%;}}

/* HEADER */
#appHeader { position:fixed; top:0; left:0; right:0; z-index:400; padding:14px 12px; display:flex; align-items:center; justify-content:space-between; pointer-events:none; }
#appHeader > * { pointer-events:all; }
.tabs { display:flex; gap:6px; }
.tab-btn { padding:8px 14px; border:1px solid var(--border); border-radius:22px; font-size:12px; font-weight:700; cursor:pointer; background:rgba(10,10,15,0.82); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); color:var(--text-dim); transition:all 0.2s; font-family:'DM Sans',sans-serif; }
.tab-btn:active { transform:scale(0.94); }
.tab-btn.active { background:rgba(245,166,35,0.18); border-color:rgba(245,166,35,0.45); color:var(--primary); }

/* GPS BADGE */
.gps-badge { display:flex; align-items:center; gap:6px; padding:7px 13px; border-radius:22px; font-size:11px; font-weight:700; background:rgba(0,232,122,0.15); border:1px solid rgba(0,232,122,0.35); color:var(--green); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); white-space:nowrap; transition:all 0.3s; }
.gps-badge.off { background:rgba(255,71,87,0.1); border-color:rgba(255,71,87,0.25); color:var(--red); }
.gps-dot { width:7px; height:7px; border-radius:50%; background:currentColor; animation:gpsDot 1.2s ease-in-out infinite; }
.gps-badge.off .gps-dot { animation:none; }
@keyframes gpsDot{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.4;transform:scale(0.7);}}

/* BOT√ïES FLUTUANTES */
#btnRecentrar { position:fixed; bottom:26px; right:18px; z-index:500; width:56px; height:56px; border-radius:50%; background:linear-gradient(135deg,#f5a828,#e07012); border:none; cursor:pointer; font-size:26px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 22px var(--primary-glow),0 2px 6px rgba(0,0,0,0.3); transition:transform 0.2s; }
#btnRecentrar:active { transform:scale(0.92); }
#btnToggle3D { position:fixed; bottom:98px; right:18px; z-index:500; width:48px; height:48px; border-radius:50%; background:rgba(10,10,15,0.88); border:1px solid rgba(61,156,255,0.4); backdrop-filter:blur(14px); display:flex; align-items:center; justify-content:center; font-size:14px; cursor:pointer; font-weight:900; font-family:'Syne',sans-serif; color:var(--blue); box-shadow:0 2px 14px rgba(0,0,0,0.5); transition:all 0.2s; }
#btnToggle3D:active { transform:scale(0.9); }
#btnToggle3D.ativo { background:rgba(61,156,255,0.2); border-color:rgba(61,156,255,0.7); box-shadow:0 2px 20px rgba(61,156,255,0.3); }
#indicadorRotacao { position:fixed; top:70px; right:16px; z-index:500; width:44px; height:44px; border-radius:50%; background:rgba(10,10,15,0.88); border:1px solid var(--border); backdrop-filter:blur(14px); display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; box-shadow:0 2px 14px rgba(0,0,0,0.5); }
#indicadorRotacao .seta { display:block; font-size:20px; transition:transform 0.5s ease; }
#headingBadge { position:fixed; bottom:158px; right:18px; z-index:500; padding:5px 10px; border-radius:12px; background:rgba(10,10,15,0.85); border:1px solid var(--border); backdrop-filter:blur(10px); font-size:10px; font-weight:700; color:var(--primary); font-family:'Syne',sans-serif; display:none; text-align:center; }

/* CHIP PROXIMIDADE */
#proximidadeChip { position:fixed; top:70px; left:50%; transform:translateX(-50%); z-index:500; white-space:nowrap; padding:8px 16px; border-radius:20px; font-size:12px; font-weight:700; backdrop-filter:blur(12px); display:none; }
#proximidadeChip.chegando { background:rgba(0,232,122,0.2); border:1px solid rgba(0,232,122,0.5); color:var(--green); animation:chipPulse 1s ease-in-out infinite; }
#proximidadeChip.longe { background:rgba(61,156,255,0.15); border:1px solid rgba(61,156,255,0.35); color:var(--blue); }
@keyframes chipPulse{0%,100%{opacity:1;}50%{opacity:0.6;}}

/* NAV AVULSA */
#navAvulsaChip { position:fixed; bottom:100px; left:50%; transform:translateX(-50%); z-index:600; display:none; align-items:center; gap:10px; padding:10px 16px 10px 14px; border-radius:24px; background:rgba(10,10,15,0.92); border:1.5px solid rgba(0,232,122,0.55); box-shadow:0 4px 24px rgba(0,232,122,0.2); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px); white-space:nowrap; }
#navAvulsaChip.visivel { display:flex; animation:chipEntrada 0.35s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes chipEntrada{from{transform:translateX(-50%) translateY(20px);opacity:0;}to{transform:translateX(-50%) translateY(0);opacity:1;}}
.nav-chip-dot { width:8px; height:8px; border-radius:50%; background:var(--green); animation:gpsDot 1s ease-in-out infinite; flex-shrink:0; }
.nav-chip-info { flex:1; }
.nav-chip-nome { font-family:'Syne',sans-serif; font-size:13px; font-weight:900; color:var(--green); }
.nav-chip-dist { font-size:11px; color:var(--text-dim); margin-top:1px; }
.nav-chip-fechar { width:28px; height:28px; border-radius:50%; background:rgba(255,71,87,0.15); border:1px solid rgba(255,71,87,0.4); color:var(--red); display:flex; align-items:center; justify-content:center; font-size:14px; cursor:pointer; flex-shrink:0; }

/* PAINEL INFERIOR */
#paradasPanel { position:fixed; bottom:0; left:0; right:0; background:rgba(12,12,26,0.97); backdrop-filter:blur(22px); -webkit-backdrop-filter:blur(22px); border-top:1px solid var(--border); border-radius:22px 22px 0 0; z-index:700; display:flex; flex-direction:column; max-height:80vh; box-shadow:0 -6px 40px rgba(0,0,0,0.6); transform:translateY(100%); transition:transform 0.32s cubic-bezier(0.32,0.72,0,1); padding-bottom:24px; }
#paradasPanel.aberto { transform:translateY(0); }
#overlayPainel { position:fixed; inset:0; z-index:690; background:rgba(0,0,0,0.5); backdrop-filter:blur(3px); display:none; }
#overlayPainel.visivel { display:block; }
.drag-handle { width:40px; height:4px; background:rgba(255,255,255,0.15); border-radius:2px; margin:12px auto 6px; flex-shrink:0; }
.panel-tabs { display:flex; gap:6px; padding:0 14px 8px; flex-shrink:0; border-bottom:1px solid var(--border); }
.tab-content { display:none; padding:14px; overflow-y:auto; }
.tab-content.active { display:block; }

/* ROTA ATIVA */
.rota-ativa-card { background:linear-gradient(135deg,rgba(245,166,35,0.12),rgba(255,140,0,0.06)); border:1px solid rgba(245,166,35,0.25); border-radius:18px; padding:14px 16px; margin-bottom:12px; }
.rota-ativa-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
.rota-nome { font-family:'Syne',sans-serif; font-size:16px; font-weight:900; color:var(--primary); }
.rota-status-badge { font-size:10px; font-weight:700; padding:4px 10px; border-radius:20px; background:rgba(0,232,122,0.15); color:var(--green); border:1px solid rgba(0,232,122,0.3); }
.rota-stats { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; }
.rota-stat { background:rgba(255,255,255,0.04); border-radius:12px; padding:10px 8px; text-align:center; }
.rota-stat-val { font-family:'Syne',sans-serif; font-size:20px; font-weight:900; }
.rota-stat-lbl { font-size:10px; color:var(--text-muted); margin-top:2px; }

/* PR√ìXIMA PARADA */
.proxima-card { background:var(--surface2); border-radius:18px; padding:14px 16px; margin-bottom:12px; border:1px solid var(--border); position:relative; overflow:hidden; }
.proxima-card::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:var(--blue); border-radius:2px 0 0 2px; }
.proxima-card.chegando::before { background:var(--green); }
.proxima-lbl { font-size:10px; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px; }
.proxima-nome { font-family:'Syne',sans-serif; font-size:17px; font-weight:800; }
.proxima-end { font-size:12px; color:var(--text-dim); margin-top:4px; }
.proxima-dist { display:flex; align-items:center; gap:8px; margin-top:10px; flex-wrap:wrap; }
.dist-badge { padding:5px 12px; border-radius:20px; font-size:12px; font-weight:700; background:rgba(61,156,255,0.15); color:var(--blue); border:1px solid rgba(61,156,255,0.3); }
.eta-badge { padding:5px 12px; border-radius:20px; font-size:12px; font-weight:700; background:rgba(245,166,35,0.12); color:var(--primary); border:1px solid rgba(245,166,35,0.25); }
.nav-btns { display:flex; gap:6px; margin-top:10px; }
.btn-nav-maps { flex:1; padding:9px; border:1px solid rgba(52,152,219,0.3); border-radius:10px; background:rgba(52,152,219,0.12); color:#5dade2; font-size:12px; font-weight:700; cursor:pointer; font-family:'DM Sans',sans-serif; }
.btn-nav-waze { flex:1; padding:9px; border:1px solid rgba(39,174,96,0.3); border-radius:10px; background:rgba(39,174,96,0.12); color:#2ecc71; font-size:12px; font-weight:700; cursor:pointer; font-family:'DM Sans',sans-serif; }

/* PARADAS */
.parada-item { display:flex; align-items:center; gap:12px; padding:12px 14px; border-radius:16px; margin-bottom:8px; background:var(--surface2); border:1px solid var(--border); transition:opacity 0.3s; }
.parada-item.entregue { opacity:0.4; }
.parada-num { width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:900; flex-shrink:0; }
.parada-num.pendente { background:rgba(61,156,255,0.2); color:var(--blue); border:1.5px solid rgba(61,156,255,0.4); }
.parada-num.proxima { background:rgba(245,166,35,0.2); color:var(--primary); border:1.5px solid rgba(245,166,35,0.4); animation:gpsDot 1.2s infinite; }
.parada-num.entregue { background:rgba(0,232,122,0.15); color:var(--green); border:1.5px solid rgba(0,232,122,0.3); }
.parada-info { flex:1; min-width:0; }
.parada-nome-item { font-size:13px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.parada-end-item { font-size:11px; color:var(--text-muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.parada-eta { font-size:11px; color:var(--text-muted); flex-shrink:0; }

/* EMPTY STATE */
.empty-state { text-align:center; padding:40px 20px; color:var(--text-muted); }
.empty-icon { font-size:48px; margin-bottom:12px; opacity:0.5; }
.empty-title { font-family:'Syne',sans-serif; font-size:16px; font-weight:800; color:var(--text-dim); margin-bottom:6px; }
.empty-sub { font-size:13px; line-height:1.6; }

/* TOAST */
#toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(80px); background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:12px 20px; border-radius:20px; font-size:13px; font-weight:700; z-index:9998; opacity:0; transition:all 0.4s cubic-bezier(0.34,1.56,0.64,1); white-space:nowrap; box-shadow:0 8px 32px rgba(0,0,0,0.5); pointer-events:none; }
#toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
#toast.success { background:rgba(0,232,122,0.15); border-color:rgba(0,232,122,0.4); color:var(--green); }
#toast.warn { background:rgba(245,166,35,0.15); border-color:rgba(245,166,35,0.4); color:var(--primary); }

/* CONFIRM MODAL */
#confirmModal { position:fixed; inset:0; z-index:8000; background:rgba(0,0,0,0.7); backdrop-filter:blur(8px); display:none; align-items:flex-end; justify-content:center; }
#confirmModal.show { display:flex; }
.confirm-box { background:var(--surface); border-radius:28px 28px 0 0; padding:24px 20px 36px; width:100%; max-width:500px; border-top:1px solid var(--border); animation:slideUp 0.35s cubic-bezier(0.34,1.4,0.64,1); }
@keyframes slideUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.confirm-icon { font-size:42px; text-align:center; margin-bottom:12px; }
.confirm-title { font-family:'Syne',sans-serif; font-size:20px; font-weight:900; text-align:center; margin-bottom:6px; }
.confirm-sub { font-size:13px; color:var(--text-dim); text-align:center; margin-bottom:20px; }
.confirm-btn { width:100%; padding:16px; border:none; border-radius:16px; font-size:15px; font-weight:800; cursor:pointer; font-family:'DM Sans',sans-serif; background:var(--green); color:#000; margin-bottom:8px; }
.confirm-cancel { width:100%; padding:14px; border:1px solid var(--border); border-radius:16px; background:transparent; color:var(--text-muted); font-size:14px; font-weight:700; cursor:pointer; font-family:'DM Sans',sans-serif; }

/* PAGAMENTO MODAL */
#pagamentoModal { position:fixed; inset:0; z-index:8500; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px); display:none; align-items:flex-end; justify-content:center; }
#pagamentoModal.show { display:flex; }
.pag-box { background:var(--surface); border-radius:28px 28px 0 0; padding:28px 20px 40px; width:100%; max-width:500px; border-top:1px solid var(--border); animation:slideUp 0.35s cubic-bezier(0.34,1.4,0.64,1); }
.pag-icon { font-size:46px; text-align:center; margin-bottom:10px; }
.pag-title { font-family:'Syne',sans-serif; font-size:19px; font-weight:900; text-align:center; margin-bottom:4px; }
.pag-sub { font-size:13px; color:var(--text-dim); text-align:center; margin-bottom:22px; line-height:1.5; }
.pag-valor { font-family:'Syne',sans-serif; font-size:32px; font-weight:900; text-align:center; color:var(--primary); margin-bottom:22px; }
.pag-btns { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.pag-sim { padding:16px; border:none; border-radius:16px; font-size:15px; font-weight:800; cursor:pointer; font-family:'DM Sans',sans-serif; background:var(--green); color:#000; }
.pag-nao { padding:16px; border:1px solid rgba(255,71,87,0.35); border-radius:16px; font-size:15px; font-weight:800; cursor:pointer; font-family:'DM Sans',sans-serif; background:rgba(255,71,87,0.15); color:var(--red); }

/* MAPLIBRE POPUP */
.maplibregl-popup-content { background:rgba(16,16,36,0.97) !important; color:white !important; border-radius:16px !important; padding:12px 16px !important; font-size:13px !important; box-shadow:0 8px 32px rgba(0,0,0,0.6) !important; border:1px solid rgba(255,255,255,0.09) !important; font-family:'DM Sans',sans-serif !important; }
.maplibregl-popup-close-button { color:rgba(255,255,255,0.5) !important; font-size:17px !important; right:6px !important; top:4px !important; }
.maplibregl-ctrl-attrib, .maplibregl-ctrl-bottom-right { display:none !important; }

@keyframes destinoPulse{0%{box-shadow:0 0 0 0 rgba(0,232,122,0.8);}70%{box-shadow:0 0 0 18px rgba(0,232,122,0);}100%{box-shadow:0 0 0 0 rgba(0,232,122,0);}}
@keyframes paradaPulse{0%,100%{box-shadow:0 0 0 0 rgba(245,166,35,0.7)}70%{box-shadow:0 0 0 12px rgba(245,166,35,0)}}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loadingScreen">
  <div class="load-logo">üõµ</div>
  <div class="load-title">O Rei da Coxinha</div>
  <div class="load-sub">Carregando rotas...</div>
  <div class="load-bar-wrap"><div class="load-bar"></div></div>
</div>

<div id="toast"></div>

<!-- PAGAMENTO MODAL -->
<div id="pagamentoModal">
  <div class="pag-box">
    <div class="pag-icon">üí∞</div>
    <div class="pag-title" id="pagNome">Cliente pagou?</div>
    <div class="pag-sub" id="pagSub">Este cliente escolheu pagar na entrega.</div>
    <div class="pag-valor" id="pagValor">R$ 0,00</div>
    <div class="pag-btns">
      <button class="pag-sim" onclick="responderPagamento(true)">‚úÖ Sim, pagou</button>
      <button class="pag-nao" onclick="responderPagamento(false)">‚ùå N√£o pagou</button>
    </div>
  </div>
</div>

<!-- DESISTIR MODAL -->
<div id="desistirModal" style="position:fixed;inset:0;z-index:8200;background:rgba(0,0,0,0.75);backdrop-filter:blur(8px);display:none;align-items:flex-end;justify-content:center;">
  <div style="background:var(--surface);border-radius:28px 28px 0 0;padding:28px 20px 40px;width:100%;max-width:500px;border-top:1px solid rgba(255,71,87,0.3);animation:slideUp 0.35s cubic-bezier(0.34,1.4,0.64,1);">
    <div style="font-size:44px;text-align:center;margin-bottom:12px;">‚ö†Ô∏è</div>
    <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:900;text-align:center;margin-bottom:6px;">Desistir da rota?</div>
    <div style="font-size:13px;color:var(--text-dim);text-align:center;margin-bottom:8px;line-height:1.6;" id="desistirSub">As entregas j√° realizadas ser√£o mantidas. A rota voltar√° para o status inicial.</div>
    <div style="font-size:12px;color:var(--red);text-align:center;margin-bottom:24px;font-weight:700;" id="desistirPendentes"></div>
    <button onclick="executarDesistirRota()" style="width:100%;padding:16px;border:none;border-radius:16px;font-size:15px;font-weight:800;cursor:pointer;font-family:'DM Sans',sans-serif;background:var(--red);color:#fff;margin-bottom:10px;">‚ö†Ô∏è Sim, desistir</button>
    <button onclick="document.getElementById('desistirModal').style.display='none'" style="width:100%;padding:14px;border:1px solid var(--border);border-radius:16px;background:transparent;color:var(--text-muted);font-size:14px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;">Cancelar</button>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div id="confirmModal">
  <div class="confirm-box">
    <div class="confirm-icon">‚úÖ</div>
    <div class="confirm-title" id="confirmTitle">Chegou!</div>
    <div class="confirm-sub" id="confirmSub"></div>
    <button class="confirm-btn" onclick="confirmarEntregaModal()">‚úì Confirmar entrega</button>
    <button class="confirm-cancel" onclick="fecharConfirmModal()">Cancelar</button>
  </div>
</div>

<div id="overlayPainel" onclick="fecharPainel()"></div>
<div id="map"></div>

<!-- HEADER -->
<div id="appHeader">
  <div class="tabs">
    <button class="tab-btn active" onclick="abrirTab('rota',event)">üó∫Ô∏è Rota</button>
    <button class="tab-btn" onclick="abrirTab('paradas',event)">üìã Paradas</button>
    <button class="tab-btn" onclick="abrirTab('todas',event)">üìÅ Todas</button>
  </div>
  <div class="gps-badge off" id="gpsBadge">
    <div class="gps-dot"></div>
    <span id="gpsText">GPS erro</span>
  </div>
</div>

<div id="indicadorRotacao" onclick="resetarRotacao()" title="Tocar para nortear">
  <span class="seta" id="setaNorte">‚¨ÜÔ∏è</span>
</div>
<button id="btnToggle3D" onclick="toggle3D()" class="ativo">3D</button>
<div id="headingBadge">0¬∞</div>
<div id="proximidadeChip">üìç Calculando...</div>

<div id="navAvulsaChip">
  <div class="nav-chip-dot"></div>
  <div class="nav-chip-info">
    <div class="nav-chip-nome" id="navAvulsaNome">Cliente</div>
    <div class="nav-chip-dist" id="navAvulsaDist">Calculando...</div>
  </div>
  <div class="nav-chip-fechar" onclick="cancelarNavAvulsa()">‚úï</div>
</div>

<button id="btnRecentrar" onclick="recentrarMapa()">üõµ</button>

<!-- PAINEL INFERIOR -->
<div id="paradasPanel">
  <div class="drag-handle"></div>
  <div class="panel-tabs tabs">
    <button class="tab-btn active" id="panelTabBtn-rota" onclick="abrirTab('rota',event)">üó∫Ô∏è Rota</button>
    <button class="tab-btn" id="panelTabBtn-paradas" onclick="abrirTab('paradas',event)">üìã Paradas</button>
    <button class="tab-btn" id="panelTabBtn-todas" onclick="abrirTab('todas',event)">üìÅ Todas</button>
  </div>
  <div id="tab-rota" class="tab-content active"><div id="rotaAtivaContent"></div></div>
  <div id="tab-paradas" class="tab-content"><div id="paradasContent"></div></div>
  <div id="tab-todas" class="tab-content"><div id="todasRotasContent"></div></div>
</div>

<script>
// ===== CONFIG =====
const SUPABASE_URL = "https://vpeyqgijajywgswmezlh.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwZXlxZ2lqYWp5d2dzd21lemxoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNTM1MDIsImV4cCI6MjA4NjgyOTUwMn0.LA5Cbof7IKWAA7l8YbCuPzANpCy0rX_Dro4l9fcDgoQ";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const FABRICA = [-8.1837523, -34.9383004]; // [lat, lng]
const RAIO_ENTREGA = 40; // metros
const OSRM_BASE = 'https://router.project-osrm.org/route/v1/driving/';

// ===== ESTADO =====
let map, meuMarcador = null, meuMarcadorEl = null;
let minhaPosicao = null; // [lng, lat] MapLibre
let posAtual = null;     // [lat, lng] c√°lculos
let ultimaPosicao = null, ultimaDirecao = 0;
let seguindoMoto = true, modo3DAtivo = true;
let bearingHistorico = [];
const MAX_HIST = 5;

let rotaAtual = null, paradasList = [], todasAsRotas = [], todosOsClientes = [];
let mediaMinPorParada = 12, realtimeCh = null, toastTimer = null;
let paradaEmConfirmacao = null, paradaAtualId = null, estavaNaParada = false;
let paradaPagamentoPendente = null;

let marcadoresMapLibre = [];
let cacheRotaCompleta = null, cacheRotaCompletaKey = '';
let ultimaProximaId = null;

let navAvulsaDestino = null, navAvulsaInterval = null, navAvulsaMarcador = null;
let gpsOk = false, ultimoEnvioGPS = 0;
const THROTTLE_GPS_MS = 3000;

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
  initMap();
  carregarDados().catch(e => console.warn('Dados:', e));
  iniciarGPS();
  iniciarRealtime();
});

// ===== MAPA =====
function initMap() {
  map = new maplibregl.Map({
    container: 'map',
    style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
    center: [FABRICA[1], FABRICA[0]], zoom: 14, pitch: 0, bearing: 0,
    attributionControl: false
  });
  map.on('load', () => {
    ['rota-completa','rota-proxima','rota-avulsa'].forEach(src => {
      map.addSource(src, { type:'geojson', data:{ type:'FeatureCollection', features:[] } });
    });
    map.addLayer({ id:'rota-completa-layer', type:'line', source:'rota-completa',
      paint:{ 'line-color':'#ff4757', 'line-width':3, 'line-opacity':0.55, 'line-dasharray':[8,5] } });
    map.addLayer({ id:'rota-proxima-layer', type:'line', source:'rota-proxima',
      paint:{ 'line-color':'#3d9cff', 'line-width':5, 'line-opacity':0.9 } });
    map.addLayer({ id:'rota-avulsa-layer', type:'line', source:'rota-avulsa',
      paint:{ 'line-color':'#00e87a', 'line-width':5, 'line-opacity':0.92 } });
    document.getElementById('loadingScreen').style.display = 'none';
    if (todosOsClientes.length || paradasList.length) renderizarMarcadores();
  });
  map.on('dragstart', () => { seguindoMoto = false; });
}

// ===== GPS-STYLE MOVER MOTO ‚Äî N√ÉO ALTERAR =====
function calcularAngulo(lat1, lng1, lat2, lng2) {
  const r = d => d * Math.PI / 180;
  const dL = r(lng2 - lng1);
  const y = Math.sin(dL) * Math.cos(r(lat2));
  const x = Math.cos(r(lat1)) * Math.sin(r(lat2)) - Math.sin(r(lat1)) * Math.cos(r(lat2)) * Math.cos(dL);
  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}
function suavizarBearing(b) {
  bearingHistorico.push(b);
  if (bearingHistorico.length > MAX_HIST) bearingHistorico.shift();
  let s = 0, c = 0;
  bearingHistorico.forEach(v => { s += Math.sin(v*Math.PI/180); c += Math.cos(v*Math.PI/180); });
  return (Math.atan2(s, c) * 180 / Math.PI + 360) % 360;
}
function moverEntregador(novaLat, novaLng, headingGPS) {
  let angulo = ultimaDirecao;
  if (ultimaPosicao) {
    const dLat = Math.abs(novaLat - ultimaPosicao.lat);
    const dLng = Math.abs(novaLng - ultimaPosicao.lng);
    if (dLat + dLng > 0.00002) {
      const raw = calcularAngulo(ultimaPosicao.lat, ultimaPosicao.lng, novaLat, novaLng);
      angulo = modo3DAtivo ? suavizarBearing(raw) : raw;
    }
  } else if (headingGPS != null && !isNaN(headingGPS)) {
    angulo = headingGPS;
  }
  ultimaDirecao = angulo;
  minhaPosicao = [novaLng, novaLat];
  posAtual = [novaLat, novaLng];

  if (!meuMarcador) {
    const el = document.createElement('div');
    el.innerHTML = `<div style="position:relative;width:56px;height:56px;display:flex;align-items:center;justify-content:center;">
      <div style="position:absolute;inset:-16px;border-radius:50%;background:radial-gradient(circle,rgba(245,166,35,0.18) 0%,transparent 70%);animation:ondaMoto 2.5s ease-out infinite;pointer-events:none;"></div>
      <div style="position:absolute;inset:-8px;border-radius:50%;border:2px solid rgba(245,166,35,0.35);animation:anelMoto 2.5s ease-out infinite;pointer-events:none;"></div>
      <img src="data:image/png;base64,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" style="width:50px;height:75px;object-fit:contain;position:relative;z-index:2;filter:drop-shadow(0 2px 12px rgba(245,166,35,0.8));transform-origin:center center;" id="motoImg" />
      <style>@keyframes ondaMoto{0%{transform:scale(0.5);opacity:0.8}80%{transform:scale(2.2);opacity:0}100%{transform:scale(0.5);opacity:0}}@keyframes anelMoto{0%{transform:scale(0.6);opacity:1}100%{transform:scale(2.4);opacity:0}}</style>
    </div>`;
    meuMarcadorEl = el;
    meuMarcador = new maplibregl.Marker({ element: el, anchor: 'center' })
      .setLngLat([novaLng, novaLat]).addTo(map);
    map.setPitch(65);
  } else {
    meuMarcador.setLngLat([novaLng, novaLat]);
  }

  const seta = document.getElementById('setaNorte');
  if (seta) seta.style.transform = `rotate(${angulo}deg)`;
  const badge = document.getElementById('headingBadge');
  if (badge) { badge.textContent = `${Math.round(((angulo%360)+360)%360)}¬∞`; badge.style.display = modo3DAtivo ? 'block' : 'none'; }

  if (seguindoMoto && modo3DAtivo) {
    map.easeTo({ center:[novaLng,novaLat], bearing:angulo, pitch:65, zoom:17, offset:[0,130], duration:800, easing:t=>t, essential:true });
  } else if (seguindoMoto) {
    map.easeTo({ center:[novaLng,novaLat], pitch:0, bearing:0, zoom:17, duration:1000 });
  }
  ultimaPosicao = { lat: novaLat, lng: novaLng };
}

function toggle3D() {
  modo3DAtivo = !modo3DAtivo;
  document.getElementById('btnToggle3D').classList.toggle('ativo', modo3DAtivo);
  if (!modo3DAtivo) {
    map.easeTo({ pitch:0, bearing:0, duration:600 });
    document.getElementById('headingBadge').style.display = 'none';
  } else {
    seguindoMoto = true;
    if (posAtual) moverEntregador(posAtual[0], posAtual[1], null);
  }
}
function resetarRotacao() {
  ultimaDirecao = 0; bearingHistorico = [];
  map.easeTo({ bearing:0, pitch:modo3DAtivo?65:0, duration:600 });
  document.getElementById('setaNorte').style.transform = 'rotate(0deg)';
  document.getElementById('headingBadge').textContent = '0¬∞';
  seguindoMoto = true;
}
function recentrarMapa() {
  seguindoMoto = true; modo3DAtivo = true;
  document.getElementById('btnToggle3D').classList.add('ativo');
  if (posAtual) moverEntregador(posAtual[0], posAtual[1], null);
  else map.flyTo({ center:[FABRICA[1],FABRICA[0]], zoom:17 });
}

// ===== GPS =====
function iniciarGPS() {
  if (!navigator.geolocation) { setBadge(false,'Sem GPS'); return; }
  setBadge(true,'Conectando...');
  navigator.geolocation.watchPosition(
    pos => processarPosicao(pos),
    () => setBadge(false,'GPS erro'),
    { enableHighAccuracy:true, timeout:15000, maximumAge:3000 }
  );
}
async function processarPosicao(pos) {
  const lat = pos.coords.latitude, lon = pos.coords.longitude;
  const acc = pos.coords.accuracy, heading = pos.coords.heading;
  setBadge(true, `¬±${Math.round(acc)}m`);
  gpsOk = true;
  let distMovida = 999;
  if (posAtual) distMovida = calcDistM(posAtual[0],posAtual[1],lat,lon);

  moverEntregador(lat, lon, heading);
  _onMoveNavAvulsa();

  const agora = Date.now();
  if (agora - ultimoEnvioGPS >= THROTTLE_GPS_MS) {
    ultimoEnvioGPS = agora;
    await enviarPosicaoSupabase(lat, lon, acc);
  }
  if (rotaAtual && paradasList.length) await verificarProximidade(lat, lon);
  if (rotaAtual && distMovida > 50) {
    const prox = paradasList.find(p => p.status==='pendente' && p.coords);
    if (prox) { ultimaProximaId = null; desenharRotaProxima([lat,lon], prox); }
  }
}
async function enviarPosicaoSupabase(lat, lon, acc=0) {
  try {
    const ts = new Date().toISOString();
    await sb.from("config").upsert(
      { key:"admin_gps", value:JSON.stringify({ lat, lon, ts, precisao:acc, rota_id:rotaAtual?.id||null }) },
      { onConflict:'key' }
    );
    if (rotaAtual?.id) {
      await sb.from("delivery_routes")
        .update({ posicao_entregador:{lat,lon,ts,precisao:acc}, entregador_lat:lat, entregador_lng:lon })
        .eq("id", rotaAtual.id);
    }
  } catch(e) { console.warn('GPS send:', e); }
}
function setBadge(on, txt) {
  document.getElementById('gpsBadge').className = 'gps-badge' + (on?'':' off');
  document.getElementById('gpsText').textContent = txt;
}

// ===== PROXIMIDADE =====
async function verificarProximidade(lat, lon) {
  let continuar = true;
  while (continuar) {
    continuar = false;
    const prox = paradasList.find(p => p.status==='pendente' && p.coords);
    if (!prox) { document.getElementById('proximidadeChip').style.display='none'; return; }
    const dist = calcDistM(lat, lon, prox.coords[0], prox.coords[1]);
    const chip = document.getElementById('proximidadeChip');
    chip.style.display = 'block';
    if (dist <= RAIO_ENTREGA) {
      chip.className = 'proximidadeChip chegando';
      chip.textContent = `‚úÖ Entregando ${prox.nome}...`;
      if (paradaAtualId !== prox.id) {
        paradaAtualId = prox.id; estavaNaParada = true;
        verificarPagamentoEntrega(prox);
        await executarMarcarEntregue(prox.id, prox.nome);
        paradaAtualId = null; estavaNaParada = false; continuar = true;
      }
    } else {
      chip.className = 'proximidadeChip longe';
      chip.textContent = dist<=200 ? `üõµ ${Math.round(dist)}m de ${prox.nome}` : `üèÅ ${Math.round(dist)}m ‚Äî ${prox.nome}`;
      estavaNaParada = false; paradaAtualId = null;
      renderProximaCard(prox, dist);
    }
  }
}

// ===== PAGAMENTO NA ENTREGA =====
async function verificarPagamentoEntrega(parada) {
  if (!parada.cliente_phone) return;
  const hoje = new Date().toISOString().split('T')[0];
  const { data: pedidos } = await sb.from("orders")
    .select("id,total,payment_method,customer_name")
    .eq("customer_phone", parada.cliente_phone)
    .gte("created_at", hoje+'T00:00:00').lte("created_at", hoje+'T23:59:59')
    .order("created_at",{ascending:false}).limit(1);
  if (!pedidos?.length) return;
  const pedido = pedidos[0];
  if ((pedido.payment_method||'').toUpperCase() !== 'PAGA NA ENTREGA') return;
  paradaPagamentoPendente = { parada, pedido };
  document.getElementById('pagNome').textContent = `${parada.nome} pagou?`;
  document.getElementById('pagSub').textContent = `Pagamento: ${pedido.payment_method} ¬∑ Pedido de hoje`;
  document.getElementById('pagValor').textContent = `R$ ${Number(pedido.total).toFixed(2).replace('.',',')}`;
  setTimeout(() => {
    document.getElementById('confirmModal').classList.remove('show');
    document.getElementById('pagamentoModal').classList.add('show');
  }, 800);
}
async function responderPagamento(pagou) {
  document.getElementById('pagamentoModal').classList.remove('show');
  if (!paradaPagamentoPendente) return;
  const { parada, pedido } = paradaPagamentoPendente; paradaPagamentoPendente = null;
  if (pagou) {
    await sb.from("orders").update({ payment_method: pedido.payment_method+' ‚úì' }).eq("id", pedido.id);
    showToast(`‚úÖ Pagamento de ${parada.nome} confirmado!`, 'success');
  } else {
    await sb.from("orders").update({ payment_method:'FIADO' }).eq("id", pedido.id);
    const { data: cli } = await sb.from("clients").select("debt").eq("phone", parada.cliente_phone).maybeSingle();
    await sb.from("clients").update({ debt:(cli?.debt||0)+Number(pedido.total) }).eq("phone", parada.cliente_phone);
    showToast(`‚ö†Ô∏è ${parada.nome} lan√ßado no fiado ‚Äî R$ ${Number(pedido.total).toFixed(2).replace('.',',')}`, 'warn');
  }
}

// ===== CONFIRM MODAL =====
function mostrarConfirmModal(parada) {
  paradaEmConfirmacao = parada;
  document.getElementById('confirmTitle').textContent = `Chegou em ${parada.nome}!`;
  document.getElementById('confirmSub').textContent = `üìç ${parada.endereco}`;
  document.getElementById('confirmModal').classList.add('show');
}
function fecharConfirmModal() { document.getElementById('confirmModal').classList.remove('show'); }
async function confirmarEntregaModal() {
  fecharConfirmModal();
  if (paradaEmConfirmacao) {
    estavaNaParada = false; paradaAtualId = null;
    await executarMarcarEntregue(paradaEmConfirmacao.id, paradaEmConfirmacao.nome);
    paradaEmConfirmacao = null;
  }
}

async function executarMarcarEntregue(id, nome) {
  const p = paradasList.find(x => x.id===id);
  if (!p || p.status==='entregue') return;
  p.status = 'entregue';
  cacheRotaCompleta = null; cacheRotaCompletaKey = ''; ultimaProximaId = null;
  setGJ('rota-proxima', null);
  await sb.from("delivery_routes").update({ paradas:paradasList }).eq("id", rotaAtual.id);
  const proxNome = paradasList.find(x => x.status==='pendente')?.nome;
  showToast(proxNome ? `‚úÖ ${nome} entregue! Pr√≥ximo: ${proxNome}` : `‚úÖ ${nome} entregue! Rota conclu√≠da!`, 'success');
  if (paradasList.every(p2 => p2.status==='entregue')) {
    await sb.from("delivery_routes").update({ status:'concluido', fim_em:new Date().toISOString() }).eq("id", rotaAtual.id);
    await sb.from("config").upsert({ key:"admin_gps", value:JSON.stringify({lat:null,lon:null,ts:null}) },{onConflict:'key'});
    showToast('üèÅ Todas as entregas conclu√≠das!', 'success');
    rotaAtual = null; setGJ('rota-completa',null); setGJ('rota-proxima',null);
  }
  renderTudo(); renderizarMarcadores();
}

// ===== OSRM =====
async function buscarOSRM(pontos) {
  if (pontos.length < 2) return null;
  const url = `${OSRM_BASE}${pontos.map(p=>`${p[1]},${p[0]}`).join(';')}?overview=full&geometries=geojson&steps=false`;
  try {
    const r = await fetch(url, { signal:AbortSignal.timeout(8000) });
    if (!r.ok) return null;
    const j = await r.json();
    return j.code==='Ok' && j.routes?.length ? j.routes[0].geometry.coordinates : null;
  } catch(e) { return null; }
}
function setGJ(src, coords, fallbackPts) {
  try {
    if (!coords && !fallbackPts) { map.getSource(src)?.setData({type:'FeatureCollection',features:[]}); return; }
    const lnglat = coords || fallbackPts.map(p=>[p[1],p[0]]);
    map.getSource(src)?.setData({type:'Feature',geometry:{type:'LineString',coordinates:lnglat}});
  } catch(e){}
}
async function desenharRotaCompleta(paradas) {
  const key = paradas.map(p=>p.id+p.status).join('|');
  let coords;
  if (cacheRotaCompletaKey===key && cacheRotaCompleta) { coords = cacheRotaCompleta; }
  else { coords = await buscarOSRM([FABRICA,...paradas.map(p=>p.coords)]); if(coords){cacheRotaCompleta=coords;cacheRotaCompletaKey=key;} }
  setGJ('rota-completa', coords, [FABRICA,...paradas.map(p=>p.coords)]);
}
async function desenharRotaProxima(pa, prox) {
  if (!pa || !prox?.coords) { setGJ('rota-proxima',null); ultimaProximaId=null; return; }
  if (ultimaProximaId===prox.id) return;
  ultimaProximaId = prox.id;
  const coords = await buscarOSRM([pa, prox.coords]);
  setGJ('rota-proxima', coords, [pa, prox.coords]);
}

// ===== NAVEGA√á√ÉO AVULSA =====
async function ativarNavAvulsa(cliente) {
  const nome = cliente.name||cliente.nome||'Cliente';
  const coords = cliente.coords;
  if (navAvulsaDestino?.nome===nome && navAvulsaDestino?.coords[0]===coords[0]) { cancelarNavAvulsa(); return; }
  cancelarNavAvulsa(false);
  navAvulsaDestino = { nome, coords };

  if (navAvulsaMarcador) { navAvulsaMarcador.remove(); navAvulsaMarcador=null; }
  const el = document.createElement('div');
  el.innerHTML = `<div style="width:44px;height:44px;border-radius:50%;background:rgba(0,232,122,0.9);display:flex;align-items:center;justify-content:center;font-size:22px;border:3px solid #fff;animation:destinoPulse 1.4s ease-out infinite;">üìç</div>`;
  navAvulsaMarcador = new maplibregl.Marker({ element:el, anchor:'bottom' })
    .setLngLat([coords[1],coords[0]])
    .setPopup(new maplibregl.Popup().setHTML(`<b>üéØ ${nome}</b><br><small>Segurar para cancelar</small>`))
    .addTo(map);

  const c = await buscarOSRM([posAtual||FABRICA, coords]);
  setGJ('rota-avulsa', c, [posAtual||FABRICA, coords]);

  document.getElementById('navAvulsaNome').textContent = `üéØ ${nome}`;
  _atualizarDistNavAvulsa();
  document.getElementById('navAvulsaChip').classList.add('visivel');
  navAvulsaInterval = setInterval(_atualizarDistNavAvulsa, 4000);
  showToast(`üó∫Ô∏è Rota para ${nome} ativada!`, 'success');
}
function _atualizarDistNavAvulsa() {
  if (!navAvulsaDestino||!posAtual) return;
  const d = calcDistM(posAtual[0],posAtual[1],navAvulsaDestino.coords[0],navAvulsaDestino.coords[1]);
  const el = document.getElementById('navAvulsaDist');
  if (!el) return;
  el.textContent = d<1000 ? `üì° ${Math.round(d)}m at√© ${navAvulsaDestino.nome}` : `üì° ${(d/1000).toFixed(1)}km at√© ${navAvulsaDestino.nome}`;
  if (d<30) { showToast(`‚úÖ Chegou em ${navAvulsaDestino.nome}!`,'success'); cancelarNavAvulsa(); }
}
function cancelarNavAvulsa(toast=true) {
  setGJ('rota-avulsa',null);
  if (navAvulsaMarcador) { navAvulsaMarcador.remove(); navAvulsaMarcador=null; }
  if (navAvulsaInterval) { clearInterval(navAvulsaInterval); navAvulsaInterval=null; }
  if (navAvulsaDestino && toast) showToast(`‚ùå Rota para ${navAvulsaDestino.nome} cancelada`);
  navAvulsaDestino = null;
  document.getElementById('navAvulsaChip').classList.remove('visivel');
}
function _onMoveNavAvulsa() {
  if (!navAvulsaDestino||!posAtual) return;
  _atualizarDistNavAvulsa();
  if (!_onMoveNavAvulsa._last) { _onMoveNavAvulsa._last=posAtual; return; }
  if (calcDistM(_onMoveNavAvulsa._last[0],_onMoveNavAvulsa._last[1],posAtual[0],posAtual[1])>80) {
    _onMoveNavAvulsa._last=posAtual;
    buscarOSRM([posAtual,navAvulsaDestino.coords]).then(c=>setGJ('rota-avulsa',c,[posAtual,navAvulsaDestino.coords]));
  }
}

// ===== DADOS =====
async function carregarDados() {
  await calcularMediaEta();
  const hoje = new Date().toISOString().split('T')[0];
  const agora = new Date();
  const horaAgora = agora.getHours() * 60 + agora.getMinutes(); // minutos desde meia-noite
  const diaSemana = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'][agora.getDay()];

  const [{ data:rotas },{ data:clientes },{ data:pedidosHoje }] = await Promise.all([
    sb.from("delivery_routes").select("*").order("hora_saida",{ascending:true}),
    sb.from("clients").select("*"),
    sb.from("orders")
      .select("customer_phone, customer_name, client_name, total, payment_method, id, details, items")
      .gte("created_at",hoje+'T00:00:00').lte("created_at",hoje+'T23:59:59')
  ]);

  const phonesComPedido = new Set((pedidosHoje||[]).map(p=>p.customer_phone).filter(Boolean));
  // Mapa phone ‚Üí pedido completo (para enriquecer paradas)
  const pedidoPorPhone = {};
  (pedidosHoje||[]).forEach(p=>{ if(p.customer_phone) pedidoPorPhone[p.customer_phone]=p; });

  // Normaliza status das rotas conforme o dia
  todasAsRotas = (rotas||[]).map(r => {
    const cHoje = r.fim_em?.startsWith(hoje), aHoje = r.saida_em?.startsWith(hoje);
    if (r.status==='concluido'&&!cHoje) return {...r,status:'criada'};
    if (r.status==='em_andamento'&&!aHoje) return {...r,status:'criada'};
    return r;
  });

  // Filtra apenas rotas do dia de hoje
  todasAsRotas = todasAsRotas.filter(r =>
    !r.dias_semana || r.dias_semana.length===0 || r.dias_semana.includes(diaSemana)
  );

  // Mapa de clientes por phone para enriquecer coordenadas
  const clientePorPhone = {};
  (clientes||[]).forEach(c=>{ if(c.phone) clientePorPhone[c.phone]=c; });

  for (const rota of todasAsRotas) {
    const tmpl = rota.paradas_template||[];
    if (!tmpl.length) continue;

    // Monta paradas ativas cruzando template √ó pedidos de hoje
    const ativas = tmpl
      .filter(p => p.cliente_phone && phonesComPedido.has(p.cliente_phone))
      .map((p, i) => {
        const pedido = pedidoPorPhone[p.cliente_phone];
        const cli    = clientePorPhone[p.cliente_phone];

        // Tenta obter coordenadas: template ‚Üí cliente cadastrado
        let coords = p.coords || null;
        if (!coords && cli?.delivery_lat && cli?.delivery_lon)
          coords = [parseFloat(cli.delivery_lat), parseFloat(cli.delivery_lon)];

        // Endere√ßo: template ‚Üí cliente
        const endereco = p.endereco || cli?.delivery_address || '';

        // Status preservado se rota j√° em andamento
        const statusSalvo = rota.status==='em_andamento'
          ? (rota.paradas?.find(a=>a.cliente_phone===p.cliente_phone)?.status || 'pendente')
          : 'pendente';

        return {
          ...p,
          coords,
          endereco,
          nome: p.nome || p.name || cli?.name || pedido?.customer_name || pedido?.client_name || p.cliente_phone,
          status: statusSalvo,
          eta_min: Math.round((i+1)*mediaMinPorParada),
          total: pedido?.total || p.total || 0,
          payment_method: pedido?.payment_method || p.payment_method || ''
        };
      })
      // S√≥ inclui paradas que t√™m coordenadas
      .filter(p => p.coords);

    // Persiste paradas se mudaram (s√≥ em rotas ainda n√£o iniciadas)
    if (rota.status==='criada' && JSON.stringify(rota.paradas||[])!==JSON.stringify(ativas)) {
      await sb.from("delivery_routes").update({paradas:ativas}).eq("id",rota.id);
    }
    rota.paradas = ativas;
  }

  todosOsClientes = (clientes||[]).map(c => {
    const coords = c.delivery_lat&&c.delivery_lon
      ? [parseFloat(c.delivery_lat),parseFloat(c.delivery_lon)] : null;
    return {...c, nome:c.name, coords};
  }).filter(c=>c.coords);

  // Verifica se alguma rota do dia deve ser iniciada automaticamente
  await verificarAutoInicioRotas(horaAgora);

  const em = todasAsRotas.find(r=>r.status==='em_andamento');
  rotaAtual = em||null; paradasList = em?.paradas||[];
  renderTudo();
  if (map.isStyleLoaded()) renderizarMarcadores();
  else map.once('load', renderizarMarcadores);
}

// ===== AUTO-IN√çCIO DE ROTA =====
async function verificarAutoInicioRotas(horaAgoraMin) {
  // J√° tem rota em andamento ‚Üí nada a fazer
  if (todasAsRotas.some(r=>r.status==='em_andamento')) return;

  // Encontra rotas prontas: status criada/aguardando, com paradas, e hor√°rio chegou
  const candidatas = todasAsRotas.filter(r => {
    if (r.status==='em_andamento'||r.status==='concluido') return false;
    if (!r.paradas?.length) return false;
    if (!r.hora_saida) return true; // sem hor√°rio definido ‚Üí sempre eleg√≠vel
    const [h,m] = r.hora_saida.split(':').map(Number);
    const horaSaida = h*60 + m;
    // S√≥ inicia se estiver dentro da janela: hor√°rio chegou E n√£o passou mais de 60 min
    return horaAgoraMin >= horaSaida && horaAgoraMin <= horaSaida + 60;
  });

  if (candidatas.length === 0) return;

  // Apenas uma candidata ‚Üí inicia automaticamente sem perguntar
  if (candidatas.length === 1) {
    await iniciarRota(candidatas[0]);
    return;
  }

  // M√∫ltiplas candidatas ‚Üí mostra modal de sele√ß√£o
  mostrarModalSelecaoRota(candidatas);
}

async function iniciarRota(rota) {
  const ts = new Date().toISOString();
  await sb.from("delivery_routes").update({
    status: 'em_andamento',
    saida_em: ts
  }).eq("id", rota.id);

  rota.status = 'em_andamento';
  rota.saida_em = ts;
  rotaAtual = rota;
  paradasList = rota.paradas || [];

  showToast(`üõµ Rota "${rota.nome}" iniciada!`, 'success');
  renderTudo();
  if (map.isStyleLoaded()) renderizarMarcadores();
}

// ===== MODAL SELE√á√ÉO DE ROTA =====
function mostrarModalSelecaoRota(rotas) {
  // Cria modal dinamicamente se n√£o existir
  let modal = document.getElementById('modalSelecaoRota');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'modalSelecaoRota';
    modal.style.cssText = 'position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);display:flex;align-items:flex-end;justify-content:center;';
    document.body.appendChild(modal);
  }

  const lista = rotas.map(r => {
    const qtd = r.paradas?.length || 0;
    const hora = r.hora_saida ? `‚è∞ ${r.hora_saida.substring(0,5)}` : '';
    return `<button onclick="window._selecionarRota('${r.id}')" style="
      width:100%;padding:16px;border:1px solid rgba(245,166,35,0.3);border-radius:16px;
      background:rgba(245,166,35,0.08);color:var(--text);text-align:left;cursor:pointer;
      font-family:'DM Sans',sans-serif;margin-bottom:10px;transition:background 0.2s;
    ">
      <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:15px;color:var(--primary);">${r.nome}</div>
      <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">${hora} &nbsp;üì¶ ${qtd} entrega${qtd!==1?'s':''}</div>
    </button>`;
  }).join('');

  modal.innerHTML = `<div style="
    background:var(--surface);border-radius:28px 28px 0 0;padding:24px 20px 40px;
    width:100%;max-width:500px;border-top:1px solid var(--border);
    animation:slideUp 0.35s cubic-bezier(0.34,1.4,0.64,1);
  ">
    <div style="width:40px;height:4px;background:rgba(255,255,255,0.15);border-radius:2px;margin:0 auto 20px;"></div>
    <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:900;margin-bottom:6px;">üõµ Qual rota iniciar?</div>
    <div style="font-size:13px;color:var(--text-muted);margin-bottom:20px;">M√∫ltiplas rotas dispon√≠veis para agora. Escolha uma para come√ßar.</div>
    ${lista}
    <button onclick="document.getElementById('modalSelecaoRota').style.display='none'" style="
      width:100%;padding:14px;border:1px solid var(--border);border-radius:16px;
      background:transparent;color:var(--text-muted);font-size:14px;font-weight:700;
      cursor:pointer;font-family:'DM Sans',sans-serif;margin-top:4px;
    ">Agora n√£o</button>
  </div>`;

  modal.style.display = 'flex';

  // Handler global tempor√°rio
  window._selecionarRota = async (rotaId) => {
    modal.style.display = 'none';
    const rota = todasAsRotas.find(r=>r.id===rotaId);
    if (rota) await iniciarRota(rota);
  };
}

async function calcularMediaEta() {
  const ontem = new Date(); ontem.setDate(ontem.getDate()-1);
  const base = ontem.toISOString().split('T')[0];
  const {data:hist} = await sb.from("delivery_routes").select("paradas,saida_em,fim_em")
    .gte("created_at",base+'T00:00:00').lte("created_at",base+'T23:59:59').eq("status","concluido").limit(5);
  if (hist?.length) {
    const ts = hist.filter(h=>h.saida_em&&h.fim_em&&h.paradas?.length).map(h=>(new Date(h.fim_em)-new Date(h.saida_em))/60000/h.paradas.length);
    if (ts.length) { mediaMinPorParada=ts.reduce((a,b)=>a+b,0)/ts.length; return; }
  }
  mediaMinPorParada = 12;
}
function iniciarRealtime() {
  if (realtimeCh) { try{sb.removeChannel(realtimeCh);}catch(e){} }
  realtimeCh = sb.channel('entregador_rotas')
    .on('postgres_changes',{event:'*',schema:'public',table:'delivery_routes'}, async()=>{ await carregarDados(); })
    .subscribe();
}

// ===== MARCADORES =====
function limparMarcadores() { marcadoresMapLibre.forEach(m=>m.remove()); marcadoresMapLibre=[]; }

function renderizarMarcadores() {
  limparMarcadores();
  const prox = paradasList.find(p=>p.status==='pendente');
  const RAIO_GRUPO = 0.00027;
  const grupos = [], usados = new Set();

  todosOsClientes.forEach((p,i) => {
    if (usados.has(i)) return;
    const grupo = [p]; usados.add(i);
    todosOsClientes.forEach((q,j) => {
      if (usados.has(j)) return;
      if (Math.abs(p.coords[0]-q.coords[0])<RAIO_GRUPO && Math.abs(p.coords[1]-q.coords[1])<RAIO_GRUPO) { grupo.push(q); usados.add(j); }
    });
    grupos.push({ coords:p.coords, clientes:grupo });
  });

  // F√°brica
  const fabEl = document.createElement('div');
  fabEl.innerHTML = `<div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#f5a623,#e67e22);display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 16px rgba(245,166,35,0.5);border:2px solid rgba(255,255,255,0.2);">üè≠</div>`;
  const fm = new maplibregl.Marker({element:fabEl,anchor:'center'})
    .setLngLat([FABRICA[1],FABRICA[0]])
    .setPopup(new maplibregl.Popup({offset:25}).setHTML('<b>üè≠ F√°brica</b>'))
    .addTo(map);
  marcadoresMapLibre.push(fm);

  // Rotas
  const pCoordsArr = paradasList.filter(p=>p.coords);
  if (pCoordsArr.length) desenharRotaCompleta(pCoordsArr); else setGJ('rota-completa',null);
  desenharRotaProxima(posAtual, prox);

  // Clientes
  grupos.forEach(({ coords, clientes }) => {
    const R=17, C=2*Math.PI*R;
    const clientesHTML = clientes.map((p,ci) => {
      const pa = paradasList.find(x => x.coords && x.coords[0]===p.coords[0] && x.coords[1]===p.coords[1] && (x.nome===(p.name||p.nome)||x.client_id===p.id||x.cliente_phone===p.phone));
      const entregue=pa?.status==='entregue', isProx=prox&&pa?.id===prox.id, isRota=!!pa;
      let bg,bc,lb,lc,rc;
      if(entregue){bg='#00e87a';bc='rgba(0,232,122,0.4)';lb='rgba(0,0,0,0.65)';lc='#aaa';rc='#00e87a';}
      else if(isProx){bg='#f5a623';bc='rgba(245,166,35,0.6)';lb='rgba(245,166,35,0.92)';lc='#000';rc='#f5a623';}
      else if(isRota){bg='#3d9cff';bc='rgba(61,156,255,0.4)';lb='rgba(10,10,15,0.85)';lc='#f0f0f8';rc='#3d9cff';}
      else{bg='#7c5cbf';bc='rgba(124,92,191,0.4)';lb='rgba(20,10,40,0.85)';lc='rgba(240,240,248,0.7)';rc='#00e87a';}
      const pulse=isProx?'animation:paradaPulse 1.5s ease-in-out infinite;':'';
      const nome=p.name||p.nome;
      const uid=`cm_${coords[0].toFixed(5).replace('.','')}_${coords[1].toFixed(5).replace('.','')}_${ci}`;
      return `<div id="${uid}" data-uid="${uid}" style="display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;-webkit-user-select:none;user-select:none;">
        <div style="background:${lb};color:${lc};font-size:10px;font-weight:800;padding:2px 7px;border-radius:10px;white-space:nowrap;max-width:90px;overflow:hidden;text-overflow:ellipsis;border:1px solid ${bc};box-shadow:0 2px 8px rgba(0,0,0,0.6);backdrop-filter:blur(6px);pointer-events:none;">${nome}</div>
        <div style="position:relative;width:44px;height:44px;">
          <svg style="position:absolute;inset:0;width:44px;height:44px;transform:rotate(-90deg);pointer-events:none;" viewBox="0 0 44 44">
            <circle cx="22" cy="22" r="${R}" fill="none" stroke="rgba(255,255,255,0.12)" stroke-width="3"/>
            <circle id="${uid}_ring" cx="22" cy="22" r="${R}" fill="none" stroke="${rc}" stroke-width="3" stroke-linecap="round" stroke-dasharray="${C.toFixed(1)}" stroke-dashoffset="${C.toFixed(1)}" style="transition:stroke-dashoffset 0.05s linear;filter:drop-shadow(0 0 4px ${rc});"/>
          </svg>
          <div id="${uid}_ico" style="position:absolute;inset:0;width:44px;height:44px;border-radius:50%;background:${bg};display:flex;align-items:center;justify-content:center;font-size:20px;border:2.5px solid rgba(255,255,255,0.25);box-shadow:0 3px 12px rgba(0,0,0,0.5);opacity:${entregue?0.5:1};transition:transform 0.15s ease;${pulse}">üë§</div>
        </div>
      </div>`;
    }).join('');

    const el = document.createElement('div');
    el.style.cssText='display:flex;flex-direction:row;align-items:flex-end;gap:4px;';
    el.innerHTML = clientesHTML;

    // Popup
    const popupHTML = clientes.map(p => {
      const pa=paradasList.find(x=>x.coords&&x.coords[0]===p.coords[0]&&x.coords[1]===p.coords[1]&&(x.nome===(p.name||p.nome)||x.client_id===p.id));
      const ent=pa?.status==='entregue', isP=prox&&pa?.id===prox.id, isR=!!pa;
      const sl=ent?'‚úÖ Entregue hoje':isP?'‚ñ∂ Pr√≥xima parada':isR?'‚è≥ Pendente':'üìç Cliente cadastrado';
      const sc=ent?'#00e87a':isP?'#f5a623':isR?'#3d9cff':'#7c5cbf';
      return `<div style="padding:6px 0;${clientes.length>1?'border-bottom:1px solid rgba(255,255,255,0.08);':''}">
        <div style="font-weight:800;font-size:13px;">${p.name||p.nome}</div>
        <div style="font-size:11px;color:rgba(240,240,248,0.55);">üìç ${p.delivery_address||p.endereco||''}</div>
        ${p.phone?`<div style="font-size:11px;color:rgba(240,240,248,0.45);">üìû ${p.phone}</div>`:''}
        ${p.debt>0?`<div style="font-size:11px;font-weight:700;color:#ff4757;">üí≥ Fiado: R$ ${Number(p.debt).toFixed(2).replace('.',',')}</div>`:''}
        <div style="font-size:11px;font-weight:700;color:${sc};margin-top:2px;">${sl}</div>
      </div>`;
    }).join('');

    const marker = new maplibregl.Marker({ element:el, anchor:'bottom' })
      .setLngLat([coords[1],coords[0]])
      .setPopup(new maplibregl.Popup({offset:[0,-10],maxWidth:'240px'}).setHTML(`<div style="min-width:160px;max-width:220px;">${popupHTML}</div>`))
      .addTo(map);
    marcadoresMapLibre.push(marker);

    // LONG-PRESS 2s
    const HOLD_MS=2000;
    let pTimer=null,rAF=null,pStart=0,pAtivo=false,uidAtivo=null;
    function iniciarHold(e) {
      let elT=e.target||e; let uid=null;
      for(let i=0;i<6&&elT;i++){if(elT.dataset?.uid){uid=elT.dataset.uid;break;}elT=elT.parentElement;}
      if(!uid) uid=`cm_${coords[0].toFixed(5).replace('.','')}_${coords[1].toFixed(5).replace('.','')}_0`;
      uidAtivo=uid; pAtivo=true; pStart=performance.now();
      const ico=document.getElementById(uid+'_ico');
      if(ico)ico.style.transform='scale(1.1)';
      function tick(){
        if(!pAtivo)return;
        const pct=Math.min((performance.now()-pStart)/HOLD_MS,1);
        const ring=document.getElementById(uid+'_ring');
        if(ring)ring.style.strokeDashoffset=(C*(1-pct)).toFixed(2);
        if(pct<1)rAF=requestAnimationFrame(tick); else completarHold(uid);
      }
      rAF=requestAnimationFrame(tick);
      pTimer=setTimeout(()=>completarHold(uid),HOLD_MS+50);
    }
    async function completarHold(uid){
      pAtivo=false; cancelAnimationFrame(rAF); clearTimeout(pTimer);
      const ring=document.getElementById(uid+'_ring'),ico=document.getElementById(uid+'_ico');
      if(ring){ring.style.transition='stroke-dashoffset 0s,opacity 0.4s';ring.style.strokeDashoffset='0';ring.style.opacity='1';
        setTimeout(()=>{ring.style.transition='stroke-dashoffset 0.15s linear,opacity 0.3s';ring.style.opacity='0';
          setTimeout(()=>{ring.style.strokeDashoffset=C.toFixed(1);ring.style.opacity='1';ring.style.transition='stroke-dashoffset 0.05s linear';},350);},280);}
      if(ico){ico.style.transform='scale(1.25)';setTimeout(()=>{ico.style.transform='';},300);}
      const ci=parseInt((uid.split('_').pop()))||0;
      await ativarNavAvulsa(clientes[Math.min(ci,clientes.length-1)]);
    }
    function cancelarHold(){
      if(!pAtivo)return; pAtivo=false; cancelAnimationFrame(rAF); clearTimeout(pTimer);
      if(uidAtivo){
        const ring=document.getElementById(uidAtivo+'_ring'),ico=document.getElementById(uidAtivo+'_ico');
        if(ring){ring.style.transition='stroke-dashoffset 0.2s ease';ring.style.strokeDashoffset=C.toFixed(1);}
        if(ico)ico.style.transform='';
      }
      uidAtivo=null;
    }
    el.addEventListener('mousedown',iniciarHold);
    el.addEventListener('touchstart',iniciarHold,{passive:true});
    el.addEventListener('mouseup',cancelarHold);
    el.addEventListener('mouseleave',cancelarHold);
    el.addEventListener('touchend',cancelarHold);
    el.addEventListener('touchcancel',cancelarHold);
  });
}

// ===== RENDER UI =====
function renderTudo() { renderRotaAtiva(); renderParadas(); renderTodasRotas(); }

function renderRotaAtiva() {
  const el=document.getElementById('rotaAtivaContent');
  if(!rotaAtual){
    const disponiveis=todasAsRotas.filter(r=>(r.status==='criada'||r.status==='aguardando')&&r.paradas?.length);
    if(disponiveis.length>0){
      el.innerHTML=`<div style="text-align:center;padding:32px 20px 16px;">
        <div style="font-size:48px;margin-bottom:12px;">üõµ</div>
        <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:900;color:var(--text);margin-bottom:6px;">Pronto para sair?</div>
        <div style="font-size:13px;color:var(--text-muted);margin-bottom:24px;line-height:1.6;">${disponiveis.length} rota${disponiveis.length>1?'s dispon√≠veis':' dispon√≠vel'} com pedidos de hoje.</div>
        ${disponiveis.map(r=>`<button onclick="iniciarRotaManual('${r.id}')" style="display:block;width:100%;padding:16px;margin-bottom:10px;background:linear-gradient(135deg,rgba(245,166,35,0.18),rgba(255,140,0,0.1));border:1px solid rgba(245,166,35,0.45);border-radius:16px;color:var(--primary);font-family:'Syne',sans-serif;font-size:15px;font-weight:900;cursor:pointer;text-align:left;">
          <div>üõµ ${r.nome}</div>
          <div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-top:4px;">üì¶ ${r.paradas.length} entrega${r.paradas.length!==1?'s':''} ${r.hora_saida?'¬∑ ‚è∞ '+r.hora_saida.substring(0,5):''}</div>
        </button>`).join('')}
      </div>`;
    } else {
      el.innerHTML=`<div class="empty-state"><div class="empty-icon">üè≠</div><div class="empty-title">Nenhuma rota dispon√≠vel</div><div class="empty-sub">N√£o h√° pedidos para hoje ou a rota ainda n√£o foi configurada.</div></div>`;
    }
    return;
  }
  const ent=paradasList.filter(p=>p.status==='entregue').length, total=paradasList.length;
  const pend=total-ent, min=Math.round(pend*mediaMinPorParada);
  const prox=paradasList.find(p=>p.status==='pendente');
  const navBtns=prox?.coords?`<div class="nav-btns"><button class="btn-nav-maps" onclick="navegarMaps(${prox.coords[0]},${prox.coords[1]})">üó∫Ô∏è Maps</button><button class="btn-nav-waze" onclick="navegarWaze(${prox.coords[0]},${prox.coords[1]})">üöó Waze</button></div>`:'';
  el.innerHTML=`
  <div class="rota-ativa-card">
    <div class="rota-ativa-header"><div class="rota-nome">${rotaAtual.nome}</div><div class="rota-status-badge">üü¢ Em andamento</div></div>
    <div class="rota-stats">
      <div class="rota-stat"><div class="rota-stat-val" style="color:var(--green);">${ent}</div><div class="rota-stat-lbl">Entregues</div></div>
      <div class="rota-stat"><div class="rota-stat-val" style="color:var(--primary);">${pend}</div><div class="rota-stat-lbl">Restantes</div></div>
      <div class="rota-stat"><div class="rota-stat-val" style="color:var(--blue);">${min}</div><div class="rota-stat-lbl">min est.</div></div>
    </div>
  </div>
  <button onclick="confirmarDesistirRota()" style="width:100%;margin-top:4px;margin-bottom:4px;padding:11px;border:1px solid rgba(255,71,87,0.3);border-radius:14px;background:rgba(255,71,87,0.08);color:var(--red);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;letter-spacing:0.2px;">‚ö†Ô∏è Desistir da rota</button>
  ${prox?`<div class="proxima-card" id="proximaCard">
    <div class="proxima-lbl">‚ñ∂ Pr√≥xima parada</div>
    <div class="proxima-nome">${prox.nome}</div>
    <div class="proxima-end">üìç ${prox.endereco}</div>
    <div class="proxima-dist"><div class="dist-badge" id="distBadge">üì° aguardando GPS...</div><div class="eta-badge">‚è±Ô∏è ~${prox.eta_min}min</div></div>
    ${navBtns}
  </div>`:`<div style="text-align:center;padding:20px;color:var(--green);"><div style="font-size:32px;">üèÅ</div><div style="font-family:'Syne',sans-serif;font-weight:900;font-size:16px;margin-top:8px;">Todas as entregas conclu√≠das!</div></div>`}`;
}
function renderProximaCard(parada, dist) {
  const b=document.getElementById('distBadge'); if(!b)return;
  if(dist<=RAIO_ENTREGA){b.style.cssText='background:rgba(0,232,122,0.15);color:var(--green);border-color:rgba(0,232,122,0.4);';b.textContent=`‚úÖ Na √°rea! ${Math.round(dist)}m`;document.getElementById('proximaCard')?.classList.add('chegando');}
  else{b.style.cssText='background:rgba(61,156,255,0.15);color:var(--blue);border-color:rgba(61,156,255,0.3);';b.textContent=`üì° ${Math.round(dist)}m`;document.getElementById('proximaCard')?.classList.remove('chegando');}
}
function renderParadas() {
  const el=document.getElementById('paradasContent');
  if(!rotaAtual||!paradasList.length){el.innerHTML=`<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">Sem paradas</div><div class="empty-sub">As paradas aparecer√£o aqui quando a rota for iniciada.</div></div>`;return;}
  const prox=paradasList.find(p=>p.status==='pendente');
  el.innerHTML=paradasList.map((p,i)=>{
    const ent=p.status==='entregue', isP=prox&&p.id===prox.id;
    return `<div class="parada-item ${ent?'entregue':''}"><div class="parada-num ${ent?'entregue':isP?'proxima':'pendente'}">${ent?'‚úì':String(i+1)}</div><div class="parada-info"><div class="parada-nome-item">${p.name||p.nome}</div><div class="parada-end-item">üìç ${p.endereco}</div></div><div class="parada-eta">‚è±Ô∏è ${p.eta_min}min</div></div>`;
  }).join('');
}
function renderTodasRotas() {
  const el=document.getElementById('todasRotasContent');
  if(!todasAsRotas.length){el.innerHTML=`<div class="empty-state"><div class="empty-icon">üìÅ</div><div class="empty-title">Sem rotas</div><div class="empty-sub">Nenhuma rota cadastrada para hoje.</div></div>`;return;}
  const cores={criada:'#f5a623',aguardando:'#3d9cff',em_andamento:'#00e87a',concluido:'#555'};
  const labels={criada:'‚è≥ Aguardando',aguardando:'üè≠ Na f√°brica',em_andamento:'üõµ Em andamento',concluido:'‚úÖ Conclu√≠da'};
  el.innerHTML=todasAsRotas.map(r=>{
    const ent=(r.paradas||[]).filter(p=>p.status==='entregue').length, tot=(r.paradas||[]).length, cor=cores[r.status]||'#555';
    const podeIniciar=(r.status==='criada'||r.status==='aguardando')&&tot>0&&r.id!==rotaAtual?.id;
    const btnIniciar=podeIniciar?`<button onclick="iniciarRotaManual('${r.id}')" style="margin-top:12px;width:100%;padding:12px;border:1px solid rgba(245,166,35,0.45);border-radius:12px;background:rgba(245,166,35,0.12);color:var(--primary);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:800;cursor:pointer;">üõµ Iniciar esta rota</button>`:'';
    return `<div style="background:var(--surface2);border-radius:16px;padding:14px;margin-bottom:8px;border-left:3px solid ${cor};">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div><div style="font-family:'Syne',sans-serif;font-weight:800;font-size:14px;">${r.nome}</div><div style="font-size:11px;color:var(--text-muted);margin-top:3px;">‚è∞ ${r.hora_saida||'--'} ¬∑ ${(r.dias_semana||[]).join(' ')}</div></div>
        <span style="font-size:10px;font-weight:700;padding:4px 10px;border-radius:20px;background:${cor}22;color:${cor};flex-shrink:0;">${labels[r.status]||r.status}</span>
      </div>
      ${tot>0?`<div style="margin-top:10px;"><div style="height:4px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;"><div style="height:100%;width:${Math.round(ent/tot*100)}%;background:${cor};border-radius:4px;transition:width 0.5s;"></div></div><div style="font-size:11px;color:var(--text-muted);margin-top:4px;">üì¶ ${ent}/${tot} entregas</div></div>`:''}
      ${btnIniciar}
    </div>`;
  }).join('');
}

// ===== DESISTIR DA ROTA =====
function confirmarDesistirRota() {
  if (!rotaAtual) return;
  const pend = paradasList.filter(p => p.status === 'pendente').length;
  const ent  = paradasList.filter(p => p.status === 'entregue').length;
  document.getElementById('desistirPendentes').textContent =
    pend > 0 ? `‚ö†Ô∏è Ainda h√° ${pend} entrega${pend>1?'s':''} pendente${pend>1?'s':''}.` : '';
  document.getElementById('desistirSub').textContent =
    ent > 0
      ? `${ent} entrega${ent>1?'s foram':' foi'} realizada${ent>1?'s':''}. A rota voltar√° ao status inicial.`
      : 'Nenhuma entrega foi realizada. A rota voltar√° ao status inicial.';
  document.getElementById('desistirModal').style.display = 'flex';
  fecharPainel();
}
async function executarDesistirRota() {
  document.getElementById('desistirModal').style.display = 'none';
  if (!rotaAtual) return;
  // Reseta paradas pendentes mantendo as entregues
  const paradasReset = paradasList.map(p => ({...p, status: p.status === 'entregue' ? 'entregue' : 'pendente'}));
  await sb.from("delivery_routes").update({
    status: 'criada',
    saida_em: null,
    paradas: paradasReset
  }).eq("id", rotaAtual.id);
  showToast(`‚ùå Rota "${rotaAtual.nome}" abandonada.`, 'warn');
  rotaAtual = null; paradasList = [];
  cacheRotaCompleta = null; cacheRotaCompletaKey = ''; ultimaProximaId = null;
  setGJ('rota-completa', null); setGJ('rota-proxima', null);
  await sb.from("config").upsert({ key:"admin_gps", value:JSON.stringify({lat:null,lon:null,ts:null}) },{onConflict:'key'});
  await carregarDados();
}

async function iniciarRotaManual(rotaId) {
  const rota = todasAsRotas.find(r=>r.id===rotaId);
  if (!rota) return;
  await iniciarRota(rota);
  fecharPainel();
}

// ===== TABS =====
let tabAtual = 'rota';
function abrirTab(nome, ev) {
  const painel=document.getElementById('paradasPanel');
  const painelAberto=painel.classList.contains('aberto');
  if(painelAberto && tabAtual===nome){fecharPainel();return;}
  tabAtual=nome;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>{ if(b.getAttribute('onclick')?.includes(`'${nome}'`))b.classList.add('active'); });
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.getElementById('tab-'+nome)?.classList.add('active');
  painel.classList.add('aberto');
  document.getElementById('overlayPainel').classList.add('visivel');
}
function fecharPainel() { document.getElementById('paradasPanel').classList.remove('aberto'); document.getElementById('overlayPainel').classList.remove('visivel'); }

// ===== NAVEGA√á√ÉO EXTERNA =====
function navegarMaps(lat,lon){window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`,'_blank');}
function navegarWaze(lat,lon){window.open(`https://waze.com/ul?ll=${lat},${lon}&navigate=yes`,'_blank');}

// ===== TOAST =====
function showToast(msg, type='') {
  const t=document.getElementById('toast'); t.textContent=msg; t.className='show '+type;
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>{t.className='';},4000);
}

// ===== UTILS =====
function calcDistM(lat1,lon1,lat2,lon2){
  const R=6371000,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
</script>

<!-- WAKE LOCK -->
<script>
let wakeLock=null;
async function ativarWakeLock(){if(!('wakeLock'in navigator))return;try{wakeLock=await navigator.wakeLock.request('screen');}catch(e){}}
document.addEventListener('visibilitychange',()=>{if(document.visibilityState==='visible')ativarWakeLock();});
window.addEventListener('load',ativarWakeLock);
</script>

<!-- CACHE DE TILES -->
<script>
const TILE_CACHE='rei-coxinha-tiles-v2';
function bboxToTiles(swLat,swLon,neLat,neLon,z){
  const l2t=lon=>Math.floor((lon+180)/360*Math.pow(2,z));
  const lat2t=lat=>Math.floor((1-Math.log(Math.tan(lat*Math.PI/180)+1/Math.cos(lat*Math.PI/180))/Math.PI)/2*Math.pow(2,z));
  return{xMin:l2t(swLon),xMax:l2t(neLon),yMin:lat2t(neLat),yMax:lat2t(swLat)};
}
(function(){
  if(!('caches'in window))return;
  const oF=window.fetch.bind(window);
  window.fetch=async function(input,init){
    const url=typeof input==='string'?input:(input?.url||'');
    if(!url.includes('cartocdn.com')&&!url.includes('openstreetmap.org'))return oF(input,init);
    try{
      const cache=await caches.open(TILE_CACHE),cached=await cache.match(url);
      if(cached)return cached.clone();
      const r=await oF(input,init);
      if(r&&r.ok)cache.put(url,r.clone()).catch(()=>{});
      return r;
    }catch(e){try{const c=await caches.open(TILE_CACHE),ca=await c.match(url);if(ca)return ca.clone();}catch(_){}throw e;}
  };
})();
async function cachearTiles(){
  if(!('caches'in window))return;
  try{const c=await caches.open(TILE_CACHE);const k=await c.keys();if(k.length>500)return;}catch(e){return;}
  const bbox={swLat:-8.26,swLon:-35.10,neLat:-8.05,neLon:-34.85},sv=['a','b','c'],z=[12,13,14,15,16,17],urls=[];
  z.forEach(zl=>{const{xMin,xMax,yMin,yMax}=bboxToTiles(bbox.swLat,bbox.swLon,bbox.neLat,bbox.neLon,zl);
    for(let x=xMin;x<=xMax;x++)for(let y=yMin;y<=yMax;y++){const s=sv[Math.abs(x+y)%3];urls.push(`https://${s}.basemaps.cartocdn.com/dark_all/${zl}/${x}/${y}.png`);if(urls.length>=1400)return;}
  });
  try{const c=await caches.open(TILE_CACHE);for(let i=0;i<urls.length;i+=15){await Promise.allSettled(urls.slice(i,i+15).map(u=>fetch(u,{mode:'cors'}).then(r=>{if(r.ok)c.put(u,r);}).catch(()=>{})));await new Promise(r=>setTimeout(r,60));}}catch(e){}
}
window.addEventListener('load',()=>setTimeout(()=>cachearTiles().catch(()=>{}),4000));
</script>

<!-- SERVICE WORKER -->
<script>
if('serviceWorker'in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('./sw.js').catch(()=>{});});}
</script>
</body>
</html>
